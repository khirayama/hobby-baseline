# TODO

## 次のタスク

~~トークンリフレッシュ時にエラーが発生する問題を修正する。~~

### ✅ リフレッシュエラー修正完了

**問題**: `@@unique([userId, deviceId])`制約違反によるリフレッシュトークン作成エラー
**解決**: unique制約を削除してアプリケーションロジックで管理

#### 修正内容
1. **schema.prismaの修正** ✅
   - `@@unique([userId, deviceId])` 制約を削除完了

2. **マイグレーション実行** ✅
   - unique制約削除のマイグレーション実行完了
   - マイグレーションファイル作成完了

3. **auth.service.tsの確認** ✅
   - 既存ロジックで適切に動作することを確認
   - 追加修正は不要

4. **全体のビルドテスト** ✅
   - 全パッケージのビルド成功を確認

### 🎯 修正結果
✅ **トークンリフレッシュ時のエラーが解決**
✅ **同一デバイスでの複数リフレッシュが可能**  
✅ **既存の複数端末ログイン機能が正常動作**

---

### ✅ 調査完了 - 問題を確認

**認識は正確でした。** 現在の実装では複数端末でのログイン状態に問題があります。

#### 🔍 確認された問題点
- **ログイン時の処理** (`auth.service.ts:115-126`): 既存の全リフレッシュトークンを無効化
- **実質的制限**: 1ユーザー1セッション制限
- **ユーザビリティ問題**: 新しい端末でログインすると他端末が強制ログアウト

#### 📋 現在の動作フロー
```
端末A: ログイン → RefreshToken_1 作成
端末B: ログイン → RefreshToken_1 無効化 + RefreshToken_2 作成  
端末A: リフレッシュ試行 → エラー（RefreshToken_1は無効）
```

### 🎯 複数端末対応の実装計画

**Phase 1: データベーススキーマ拡張**
- RefreshTokenテーブルにdeviceId, deviceName フィールド追加
- Prismaマイグレーション実行

**Phase 2: AuthServiceロジック修正** 
- ログイン時: 同一デバイスのトークンのみ無効化
- デバイス数制限（最大5台）の実装

**Phase 3: フロントエンド対応**
- Web/NativeでdeviceId生成・送信
- デバイス識別ロジック追加

**Phase 4: セッション管理**
- ユーザー設定画面での複数セッション表示
- 個別セッション削除機能

### ✅ Phase 1-3 実装完了

**Phase 1: データベーススキーマ拡張** ✅
- RefreshTokenテーブルに`deviceId`, `deviceName`フィールド追加完了
- 複合unique制約 `(userId, deviceId)` 追加完了
- 既存レコードのlegacy化完了

**Phase 2: AuthServiceロジック修正** ✅  
- ログイン時: 同一デバイスのトークンのみ無効化に変更完了
- デバイス数制限: 最大5台の実装完了
- リフレッシュトークン継承: デバイス情報の継承完了
- 型定義・バリデーション更新完了

**Phase 3: フロントエンド対応** ✅
- Web: ブラウザフィンガープリント基のデバイスID生成完了
- Native: プラットフォーム基のデバイスID生成完了
- 両プラットフォームでの認証時デバイス情報送信完了

### 🎯 解決された問題
✅ **複数端末での同時ログインが可能**
✅ **一つの端末でのトークン更新が他端末に影響しない**
✅ **デバイス数制限によるセキュリティ確保**
✅ **ユーザーフレンドリーなデバイス名表示**

## 次以降のタスク
